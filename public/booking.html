<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุญุฌุฒ ุฑุญูุฉ - ูุตููู</title>
    <link rel="stylesheet" href="/css/theme.css">
    <link rel="stylesheet" href="/css/booking.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800;900&display=swap"
        rel="stylesheet">
</head>

<body>
    <div class="booking-container">
        <!-- Header -->
        <header class="booking-header">
            <a href="/" class="back-btn" data-i18n="back_to_home">โ ุงูุนูุฏุฉ ููุฑุฆูุณูุฉ</a>
            <div class="logo">
                <span class="logo-icon">๐</span>
                <h1 class="logo-text">ูุตููู</h1>
            </div>
            <h2 class="page-title" data-i18n="book_trip_now">ุงุญุฌุฒ ุฑุญูุชู ุงูุขู</h2>
        </header>

        <!-- Main Content -->
        <div class="booking-content">
            <!-- Map Section -->
            <div class="map-section">
                <div class="map-header">
                    <h3 data-i18n="set_location_on_map">๐ ุญุฏุฏ ูููุนู ุนูู ุงูุฎุฑูุทุฉ</h3>

                    <!-- Search Boxes -->
                    <div class="search-boxes">
                        <div class="search-box-wrapper">
                            <label class="search-label" data-i18n="search_pickup">๐ต ุงุจุญุซ ุนู ููุทุฉ ุงูุงูุทูุงู</label>
                            <input id="pickupSearch" type="text" class="search-input"
                                data-i18n-placeholder="search_placeholder">
                        </div>
                        <div class="search-box-wrapper">
                            <label class="search-label" data-i18n="search_dropoff">๐ด ุงุจุญุซ ุนู ููุทุฉ ุงููุตูู</label>
                            <input id="dropoffSearch" type="text" class="search-input"
                                data-i18n-placeholder="search_placeholder">
                        </div>
                    </div>

                    <div class="or-divider">
                        <span>ุฃู ุงุถุบุท ุนูู ุงูุฎุฑูุทุฉ ูุจุงุดุฑุฉ</span>
                    </div>

                    <div class="location-toggle">
                        <button id="pickupBtn" class="toggle-btn active">ููุทุฉ ุงูุงูุทูุงู</button>
                        <button id="dropoffBtn" class="toggle-btn">ููุทุฉ ุงููุตูู</button>
                    </div>
                </div>
                <div id="map" class="map-container"></div>

                <!-- Selected Locations Display -->
                <div class="locations-display">
                    <div class="location-info">
                        <span class="location-icon">๐ต</span>
                        <div>
                            <div class="location-label" data-i18n="from">ูู</div>
                            <div id="pickupAddress" class="location-address" data-i18n="click_map_pickup">ุงุถุบุท ุนูู
                                ุงูุฎุฑูุทุฉ ูุชุญุฏูุฏ ูููุน ุงูุงูุทูุงู</div>
                        </div>
                    </div>
                    <div class="location-info">
                        <span class="location-icon">๐ด</span>
                        <div>
                            <div class="location-label" data-i18n="to">ุฅูู</div>
                            <div id="dropoffAddress" class="location-address" data-i18n="click_map_dropoff">ุงุถุบุท ุนูู
                                ุงูุฎุฑูุทุฉ ูุชุญุฏูุฏ ูููุน ุงููุตูู</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Booking Form -->
            <div class="booking-form-section">
                <form id="bookingForm" class="booking-form">
                    <div class="form-header">
                        <h3 data-i18n="booking_details">๐ ุจูุงูุงุช ุงูุญุฌุฒ</h3>
                    </div>

                    <div class="form-group">
                        <label class="form-label" data-i18n="full_name">ุงูุงุณู ุงููุงูู *</label>
                        <input type="text" id="passengerName" class="form-input"
                            data-i18n-placeholder="name_placeholder" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label" data-i18n="phone">ุฑูู ุงููุงุชู *</label>
                        <input type="tel" id="passengerPhone" class="form-input" placeholder="01234567890" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label" data-i18n="trip_datetime">ุชุงุฑูุฎ ูููุช ุงูุฑุญูุฉ *</label>
                        <input type="datetime-local" id="tripDateTime" class="form-input" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label" data-i18n="passengers_count">ุนุฏุฏ ุงูุฑูุงุจ</label>
                        <select id="passengersCount" class="form-input">
                            <option value="1" data-i18n="one_passenger">ุฑุงูุจ ูุงุญุฏ</option>
                            <option value="2" data-i18n="two_passengers">2 ุฑูุงุจ</option>
                            <option value="3" data-i18n="three_passengers">3 ุฑูุงุจ</option>
                            <option value="4" data-i18n="four_passengers">4 ุฑูุงุจ</option>
                            <option value="5" data-i18n="five_plus_passengers">5+ ุฑูุงุจ</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label" data-i18n="additional_notes">ููุงุญุธุงุช ุฅุถุงููุฉ</label>
                        <textarea id="notes" class="form-input" rows="3"
                            data-i18n-placeholder="notes_placeholder"></textarea>
                    </div>

                    <!-- Trip Summary -->
                    <div class="trip-summary">
                        <h4 data-i18n="trip_summary">๐ ููุฎุต ุงูุฑุญูุฉ</h4>
                        <div class="summary-item">
                            <span data-i18n="approx_distance">ุงููุณุงูุฉ ุงูุชูุฑูุจูุฉ:</span>
                            <strong id="distance">-- ูู</strong>
                        </div>
                        <div class="summary-item">
                            <span data-i18n="expected_duration">ุงูููุช ุงููุชููุน:</span>
                            <strong id="duration">-- ุฏูููุฉ</strong>
                        </div>
                        <div class="summary-item">
                            <span data-i18n="approx_price">ุงูุณุนุฑ ุงูุชูุฑูุจู:</span>
                            <strong id="estimatedPrice">-- ุฌููู</strong>
                        </div>
                    </div>

                    <div id="errorMessage" class="error-message" style="display: none;"></div>
                    <div id="successMessage" class="success-message" style="display: none;">
                        โ ุชู ุญุฌุฒ ุฑุญูุชู ุจูุฌุงุญ! ุณูุชู ุงูุชูุงุตู ูุนู ูุฑูุจุงู
                    </div>

                    <button type="submit" class="btn-submit">
                        <span class="btn-icon">๐ซ</span>
                        <span class="btn-text" data-i18n="confirm_booking">ุชุฃููุฏ ุงูุญุฌุฒ</span>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Google Maps API -->
    <script
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBFw0Qbyq9zTFTd-tUY6dZWTgaQzuU17R8&libraries=places&language=ar"></script>

    <script>
        let map;
        let pickupMarker;
        let dropoffMarker;
        let directionsService;
        let directionsRenderer;
        let geocoder;

        let pickupLocation = null;
        let dropoffLocation = null;
        let selectingPickup = true;

        const API_BASE = 'http://localhost:3000/api';

        // Setup Google Places Autocomplete
        function setupAutocomplete() {
            // Autocomplete for pickup location
            const pickupAutocomplete = new google.maps.places.Autocomplete(
                document.getElementById('pickupSearch'),
                {
                    componentRestrictions: { country: 'eg' }, // Egypt only
                    fields: ['formatted_address', 'geometry', 'name']
                }
            );

            pickupAutocomplete.addListener('place_changed', () => {
                const place = pickupAutocomplete.getPlace();
                if (!place.geometry || !place.geometry.location) {
                    showError('ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูููุงู');
                    return;
                }

                // Set pickup location
                const location = place.geometry.location;
                placeMarkerFromSearch(location, 'pickup', place.formatted_address || place.name);
                map.setCenter(location);
                map.setZoom(15);
            });

            // Autocomplete for dropoff location
            const dropoffAutocomplete = new google.maps.places.Autocomplete(
                document.getElementById('dropoffSearch'),
                {
                    componentRestrictions: { country: 'eg' }, // Egypt only
                    fields: ['formatted_address', 'geometry', 'name']
                }
            );

            dropoffAutocomplete.addListener('place_changed', () => {
                const place = dropoffAutocomplete.getPlace();
                if (!place.geometry || !place.geometry.location) {
                    showError('ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูููุงู');
                    return;
                }

                // Set dropoff location
                const location = place.geometry.location;
                placeMarkerFromSearch(location, 'dropoff', place.formatted_address || place.name);
                map.setCenter(location);
                map.setZoom(15);
            });
        }

        // Place marker from search (separate from click)
        function placeMarkerFromSearch(location, type, address) {
            if (type === 'pickup') {
                if (pickupMarker) pickupMarker.setMap(null);

                pickupMarker = new google.maps.Marker({
                    position: location,
                    map: map,
                    icon: {
                        url: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png'
                    },
                    animation: google.maps.Animation.DROP
                });

                pickupLocation = location;
                document.getElementById('pickupAddress').textContent = address;

            } else {
                if (dropoffMarker) dropoffMarker.setMap(null);

                dropoffMarker = new google.maps.Marker({
                    position: location,
                    map: map,
                    icon: {
                        url: 'http://maps.google.com/mapfiles/ms/icons/red-dot.png'
                    },
                    animation: google.maps.Animation.DROP
                });

                dropoffLocation = location;
                document.getElementById('dropoffAddress').textContent = address;
            }

            // If both locations selected, calculate route
            if (pickupLocation && dropoffLocation) {
                calculateRoute();
            }
        }

        // Initialize Map
        function initMap() {
            // Default to Cairo
            const defaultCenter = { lat: 30.0444, lng: 31.2357 };

            map = new google.maps.Map(document.getElementById('map'), {
                center: defaultCenter,
                zoom: 12,
                mapTypeControl: false,
                streetViewControl: false,
                styles: [
                    {
                        featureType: "poi",
                        elementType: "labels",
                        stylers: [{ visibility: "off" }]
                    }
                ]
            });

            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({
                map: map,
                suppressMarkers: true,
                polylineOptions: {
                    strokeColor: '#667eea',
                    strokeWeight: 5
                }
            });
            geocoder = new google.maps.Geocoder();

            // Setup Google Places Autocomplete
            setupAutocomplete();

            // Click event to place markers
            map.addListener('click', (event) => {
                placeMarker(event.latLng);
            });

            // Try to get user's current location
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        map.setCenter(userLocation);
                    },
                    () => {
                        console.log('Could not get user location');
                    }
                );
            }
        }

        // Place marker on map
        function placeMarker(location) {
            if (selectingPickup) {
                if (pickupMarker) pickupMarker.setMap(null);

                pickupMarker = new google.maps.Marker({
                    position: location,
                    map: map,
                    icon: {
                        url: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png'
                    },
                    animation: google.maps.Animation.DROP
                });

                pickupLocation = location;
                getAddress(location, 'pickup');

            } else {
                if (dropoffMarker) dropoffMarker.setMap(null);

                dropoffMarker = new google.maps.Marker({
                    position: location,
                    map: map,
                    icon: {
                        url: 'http://maps.google.com/mapfiles/ms/icons/red-dot.png'
                    },
                    animation: google.maps.Animation.DROP
                });

                dropoffLocation = location;
                getAddress(location, 'dropoff');
            }

            // If both locations selected, calculate route
            if (pickupLocation && dropoffLocation) {
                calculateRoute();
            }
        }

        // Get address from coordinates
        function getAddress(location, type) {
            geocoder.geocode({ location: location }, (results, status) => {
                if (status === 'OK' && results[0]) {
                    const address = results[0].formatted_address;
                    document.getElementById(type + 'Address').textContent = address;
                }
            });
        }

        // Calculate route
        function calculateRoute() {
            directionsService.route(
                {
                    origin: pickupLocation,
                    destination: dropoffLocation,
                    travelMode: google.maps.TravelMode.DRIVING
                },
                (response, status) => {
                    if (status === 'OK') {
                        directionsRenderer.setDirections(response);

                        const route = response.routes[0].legs[0];
                        const distanceKm = (route.distance.value / 1000).toFixed(1);
                        const durationMin = Math.round(route.duration.value / 60);
                        const estimatedPrice = Math.round(distanceKm * 5); // 5 ุฌููู ูููููู

                        document.getElementById('distance').textContent = distanceKm + ' ูู';
                        document.getElementById('duration').textContent = durationMin + ' ุฏูููุฉ';
                        document.getElementById('estimatedPrice').textContent = estimatedPrice + ' ุฌููู';
                    }
                }
            );
        }

        // Toggle buttons
        document.getElementById('pickupBtn').addEventListener('click', () => {
            selectingPickup = true;
            document.getElementById('pickupBtn').classList.add('active');
            document.getElementById('dropoffBtn').classList.remove('active');
        });

        document.getElementById('dropoffBtn').addEventListener('click', () => {
            selectingPickup = false;
            document.getElementById('dropoffBtn').classList.remove('active');
            document.getElementById('pickupBtn').classList.add('active');
        });

        // Form submission
        document.getElementById('bookingForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!pickupLocation || !dropoffLocation) {
                showError('ูุฑุฌู ุชุญุฏูุฏ ููุทุฉ ุงูุงูุทูุงู ูุงููุตูู ุนูู ุงูุฎุฑูุทุฉ');
                return;
            }

            const bookingData = {
                passenger_name: document.getElementById('passengerName').value,
                passenger_phone: document.getElementById('passengerPhone').value,
                pickup_lat: pickupLocation.lat(),
                pickup_lng: pickupLocation.lng(),
                pickup_address: document.getElementById('pickupAddress').textContent,
                dropoff_lat: dropoffLocation.lat(),
                dropoff_lng: dropoffLocation.lng(),
                dropoff_address: document.getElementById('dropoffAddress').textContent,
                trip_datetime: document.getElementById('tripDateTime').value,
                passengers_count: document.getElementById('passengersCount').value,
                notes: document.getElementById('notes').value,
                distance: document.getElementById('distance').textContent,
                duration: document.getElementById('duration').textContent,
                estimated_price: document.getElementById('estimatedPrice').textContent
            };

            try {
                const response = await fetch(`${API_BASE}/bookings`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(bookingData)
                });

                const data = await response.json();

                if (data.success) {
                    showSuccess();
                    document.getElementById('bookingForm').reset();

                    setTimeout(() => {
                        window.location.reload();
                    }, 3000);
                } else {
                    showError(data.error || 'ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุญุฌุฒ');
                }
            } catch (error) {
                showError('ุฎุทุฃ ูู ุงูุงุชุตุงู ุจุงูุฎุงุฏู');
            }
        });

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = 'โ ' + message;
            errorDiv.style.display = 'block';
            document.getElementById('successMessage').style.display = 'none';
            setTimeout(() => errorDiv.style.display = 'none', 5000);
        }

        function showSuccess() {
            document.getElementById('successMessage').style.display = 'block';
            document.getElementById('errorMessage').style.display = 'none';
        }

        // Initialize map on load
        window.onload = initMap;
    </script>

    <!-- Theme & Language Manager -->
    <script src="/js/theme-manager.js"></script>
</body>

</html>